name: Test ðŸ§ª

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test:
    name: Test and check ï¸ðŸ”Ž
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        lua-version: [
          "5.1",
          "5.2",
          "5.3",
          "5.4",
          "luajit"
        ]
    steps:
    - uses: actions/checkout@v4
    - uses: jkl1337/gh-actions-lua@v11
      with:
        luaVersion: "${{ matrix.lua-version }}"
    - uses: jkl1337/gh-actions-luarocks@v5
      with:
        luaRocksVersion: "3.11.1"
    - name: Install dependencies
      run: |
        luarocks install luacheck
        luarocks install busted
        luarocks install luacov
    - name: Run tests and checks
      run: |
        luacheck --no-unused-args --std max+busted smiti18n spec
        busted --verbose --coverage
    - name: Generate and show coverage report
      run: |
        luacov
        cat luacov.report.out
        {
          echo "# Test Coverage Summary - ${{ matrix.lua-version }}"
          echo ""
          echo "| File | Hits | Missed | Coverage |"
          echo "|------|------|---------|----------|"
          grep "^smiti18n/.*[0-9]" luacov.report.out | sort -u | sed -E 's/^([^|]+[^ ])[[:space:]]+([0-9]+)[[:space:]]+([0-9]+)[[:space:]]+([0-9.]+)%[[:space:]]*$/| \1 | \2 | \3 | \4% |/'
        } >> $GITHUB_STEP_SUMMARY
